name: Release

on:
  push:
    branches: [main]

permissions: {}

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  release-please:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
    steps:
      - id: release
        uses: google-github-actions/release-please-action@e4dc86ba9405554aeba3c6bb2d169500e7d3b4ee # v4.1.1
        with:
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

  publish-pypi:
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      id-token: write
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: astral-sh/setup-uv@5a095e7a2014a4212f075830d4f7277575a9d098 # v7.3.1
      - uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: "3.13"
      - name: Build package
        run: cd Wrapping/Python/MCPServer && uv build
      - uses: pypa/gh-action-pypi-publish@ed0c53931b1dc9bd32cbe73a98c7f6766f8a527e # v1.13.0
        with:
          packages-dir: Wrapping/Python/MCPServer/dist

  # ---------------------------------------------------------------------------
  # Linux x86_64 — built inside the project CI container (Qt6)
  # ---------------------------------------------------------------------------
  build-plugin-linux:
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    container: ghcr.io/${{ github.repository }}-ci:6.0.1
    env:
      TAG_NAME: ${{ needs.release-please.outputs.tag_name }}
    steps:
      - name: Install build dependencies
        run: |
          apt-get update
          apt-get install -y --no-install-recommends python3-pip qt6-tools-dev git
          pip3 install cmake==3.31.4

      - name: Checkout source
        run: |
          git clone --depth 1 --branch "$TAG_NAME" \
            https://github.com/${{ github.repository }}.git source

      - name: Configure
        run: |
          cmake \
            -S source \
            -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=$PWD/install \
            -DParaView_DIR=/opt/paraview/lib/cmake/paraview-6.0 \
            -DBUILD_TESTING=OFF

      - name: Build
        run: cmake --build build --parallel $(nproc)

      - name: Install
        run: cmake --install build

      - name: Package tarball
        run: |
          VERSION="${TAG_NAME#v}"
          ARCHIVE_DIR="ParaViewMCP-${VERSION}-ParaView-6.0.1-linux-x86_64"
          mkdir -p "${ARCHIVE_DIR}"
          cp install/lib/paraview-6.0/plugins/ParaViewMCP/ParaViewMCP.so "${ARCHIVE_DIR}/"
          cp install/lib/paraview-6.0/plugins/ParaViewMCP.plugins.xml "${ARCHIVE_DIR}/"
          cp source/LICENSE "${ARCHIVE_DIR}/"
          cp source/.github/INSTALL_PLUGIN.md "${ARCHIVE_DIR}/INSTALL.md"
          tar czf "${ARCHIVE_DIR}.tar.gz" "${ARCHIVE_DIR}"
          echo "ARCHIVE_NAME=${ARCHIVE_DIR}.tar.gz" >> $GITHUB_ENV

      - name: Upload build artifact
        uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f # v7.0.0
        with:
          name: plugin-linux-x86_64
          path: ${{ env.ARCHIVE_NAME }}
          if-no-files-found: error

  # ---------------------------------------------------------------------------
  # macOS arm64 — native build on Apple Silicon runner
  # ---------------------------------------------------------------------------
  build-plugin-macos:
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: macos-14
    timeout-minutes: 120
    permissions:
      contents: read
    env:
      PARAVIEW_VERSION: v6.0.1
      TAG_NAME: ${{ needs.release-please.outputs.tag_name }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install dependencies
        run: brew install cmake ninja qt@6

      - name: Cache ParaView SDK
        id: cache-paraview
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: /tmp/paraview-sdk
          key: paraview-${{ env.PARAVIEW_VERSION }}-macos-arm64-qt6

      - name: Build ParaView SDK
        if: steps.cache-paraview.outputs.cache-hit != 'true'
        run: |
          git clone --recursive --branch ${{ env.PARAVIEW_VERSION }} --depth 1 \
            https://gitlab.kitware.com/paraview/paraview.git /tmp/paraview-src
          cmake \
            -S /tmp/paraview-src \
            -B /tmp/paraview-build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=/tmp/paraview-sdk \
            -DBUILD_SHARED_LIBS=ON \
            -DBUILD_TESTING=OFF \
            -DPARAVIEW_BUILD_QT_GUI=ON \
            -DPARAVIEW_USE_QT=ON \
            -DPARAVIEW_ENABLE_PYTHON=ON \
            -DPARAVIEW_USE_MPI=OFF \
            -DPARAVIEW_ENABLE_WEB=OFF \
            -DPARAVIEW_ENABLE_EXAMPLES=OFF \
            -DVTK_WRAP_PYTHON=ON \
            -DCMAKE_PREFIX_PATH="$(brew --prefix qt@6)"
          cmake --build /tmp/paraview-build --parallel $(sysctl -n hw.ncpu)
          cmake --install /tmp/paraview-build

      - name: Configure
        run: |
          cmake \
            -S . \
            -B build \
            -G Ninja \
            -DCMAKE_PREFIX_PATH="/tmp/paraview-sdk;$(brew --prefix qt@6)" \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=$PWD/install \
            -DBUILD_TESTING=OFF

      - name: Build
        run: cmake --build build --parallel $(sysctl -n hw.ncpu)

      - name: Install
        run: cmake --install build

      - name: Package tarball
        run: |
          VERSION="${TAG_NAME#v}"
          ARCHIVE_DIR="ParaViewMCP-${VERSION}-ParaView-6.0.1-macos-arm64"
          mkdir -p "${ARCHIVE_DIR}"
          cp install/lib/paraview-6.0/plugins/ParaViewMCP/ParaViewMCP.so "${ARCHIVE_DIR}/"
          cp install/lib/paraview-6.0/plugins/ParaViewMCP.plugins.xml "${ARCHIVE_DIR}/"
          cp LICENSE "${ARCHIVE_DIR}/"
          cp .github/INSTALL_PLUGIN.md "${ARCHIVE_DIR}/INSTALL.md"
          tar czf "${ARCHIVE_DIR}.tar.gz" "${ARCHIVE_DIR}"
          echo "ARCHIVE_NAME=${ARCHIVE_DIR}.tar.gz" >> $GITHUB_ENV

      - name: Upload build artifact
        uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f # v7.0.0
        with:
          name: plugin-macos-arm64
          path: ${{ env.ARCHIVE_NAME }}
          if-no-files-found: error

  # ---------------------------------------------------------------------------
  # Upload all platform binaries to the GitHub Release
  # ---------------------------------------------------------------------------
  upload-plugin-binaries:
    needs: [release-please, build-plugin-linux, build-plugin-macos]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      TAG_NAME: ${{ needs.release-please.outputs.tag_name }}
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@70fc10c6e5e1ce46ad2ea6f2b72d43f7d47b13c3 # v8.0.0
        with:
          pattern: plugin-*
          merge-multiple: true

      - name: Upload to GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release upload "$TAG_NAME" *.tar.gz --repo "${{ github.repository }}"
